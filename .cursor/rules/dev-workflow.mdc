---
description: "开发流程管理规则 - 用自然语言口语管理任务状态、分支、Linear 工单，支持 plan 同步到 Linear"
alwaysApply: true
---

# ===== 项目配置（按需修改） =====

project:
  name: "智能数据分析助理"
  team: "智能数据分析"
  repo: "https://github.com/sgerpguochao/NL2SQL_Agent.git"
  github_username: "sgerpguochao"
  github_token: ""  # 请在本地填入你的 GitHub Personal Access Token
  default_branch: "main"
  branch_prefix: "feat"
  plan_file: ".cursor/plans/nl2sql_analysis_system_5bb4d91a.plan.md"

# ===== 计划同步规则 =====

用户会用 Markdown 编写开发计划，格式按 Phase 分阶段组织。
你需要能将计划中的任务同步到 Linear 项目中。

## 计划文件格式约定

用户的计划文件使用以下结构：

```markdown
## Phase 1：阶段名称
- [ ] 任务1 描述
- [ ] 任务2 描述

## Phase 2：阶段名称
- [ ] 任务3 描述
- [ ] 任务4 描述
```

也兼容 plan frontmatter 中的 todos 格式：

```yaml
todos:
  - id: p1-xxx
    content: "Phase1：任务描述"
    status: pending
```

## 同步计划到 Linear

触发词：「同步计划」「同步到 Linear」「把计划推到 Linear」「更新 Linear」

执行动作：
1. 读取 plan 文件，解析所有 Phase 和 todo 项
2. 在 Linear 项目（project.name）中，按 Phase 创建或更新 Issue：
   - Issue 标题格式：`[Phase N] 任务描述`
   - Issue 标签：添加对应的 Phase 标签（如 `Phase 1`），如标签不存在则先创建
   - Issue 状态映射：
     - `pending` → Backlog
     - `in_progress` → In Progress
     - `completed` → Done
     - `cancelled` → Canceled
3. 避免重复创建：同步前先用 `list_issues` 查询项目下已有的 Issue，通过标题匹配判断是否已存在
   - 已存在：更新状态
   - 不存在：创建新 Issue
4. 输出同步报告：

```
======== 计划同步报告 ========
项目：{project.name}
团队：{project.team}

Phase 1：阶段名称
  ✅ 已同步：[Phase 1] 任务1    -> TES-xx (Backlog)
  🆕 新创建：[Phase 1] 任务2    -> TES-xx (Backlog)

Phase 2：阶段名称
  🆕 新创建：[Phase 2] 任务3    -> TES-xx (Backlog)

总计：新建 2 / 更新 1 / 跳过 0
================================
```

## 从 Linear 同步回计划

触发词：「从 Linear 拉取」「同步回来」「拉取进度」

执行动作：
1. 用 `list_issues` 查询 Linear 项目下所有 Issue
2. 将 Linear Issue 状态映射回 plan 的 todo 状态
3. 更新 plan 文件
4. 输出变更列表

# ===== 自动同步规则（最高优先级） =====

无论是用户口头指令还是 AI 主动执行开发任务，只要任务状态发生变化，都必须**同时**更新本地 plan 文件和 Linear Issue。

## 核心原则：代码完成 = Linear 同步

当你（AI）在执行开发任务时（写代码、安装依赖、启动服务、运行测试等），必须遵守：

1. **开始执行任务前**：将对应 plan todo 设为 `in_progress`，将 Linear Issue 设为 `In Progress`
2. **任务验证通过后**：将对应 plan todo 设为 `completed`，将 Linear Issue 设为 `Done`
3. **Phase 级别完成**：当一个 Phase 的所有任务都变为 `completed` 时，在完成最后一个任务的同步操作后，输出 Phase 完成总结

## 状态映射表

| plan todo status | Linear Issue 状态 |
|------------------|------------------|
| `pending`        | Backlog          |
| `in_progress`    | In Progress      |
| `completed`      | Done             |
| `cancelled`      | Canceled         |

## 执行时机

以下场景必须触发自动同步：
- 用户说「开始做 Phase X」或「做 Phase X 的代码」→ 该 Phase 所有任务依次：开始时设 In Progress，完成时设 Done
- 用户说「开始做 XXX 任务」→ 单个任务：开始时设 In Progress，完成时设 Done
- 用户说「完成 XXX」→ 设 Done
- AI 自行判断任务已完成（代码写好、测试通过）→ 设 Done
- 同步失败时：仅更新本地 plan，在输出中提示 Linear 同步失败原因

## 查找 Linear Issue 的方法

同步时通过以下方式查找对应的 Linear Issue：
1. 用 `list_issues` 查询项目下的 Issue，通过标题中的 `[Phase N]` 和任务关键字模糊匹配
2. 匹配成功后，使用 `update_issue` 更新状态
3. 如果找不到对应 Issue，自动创建一个新的

# ===== 口语指令识别规则 =====

当用户使用日常口语描述开发意图时，你需要理解其含义并自动执行对应的工作流操作。
以下是口语模式与对应动作的映射：

## 一、开始任务

触发词：「开始做 XXX」「我要做 XXX」「启动 XXX」「搞 XXX」「着手 XXX」「做 XXX 的代码」「帮我做 XXX」

执行动作（全部为强制步骤）：
1. 在 plan 文件中找到最匹配的 todo 项，将其状态更新为 `in_progress`
2. **【强制】** 使用 Linear MCP 工具将对应 Issue 状态设为 `In Progress`
3. 推荐 git 分支名，格式：`{branch_prefix}/{简短英文描述}`
4. 输出确认信息后，开始执行开发工作
5. 开发工作完成并验证通过后，**【强制】** 执行完成流程（见下方"二、完成任务"）

如果触发词包含整个 Phase（如「做 Phase 1 全部代码」），则：
1. 该 Phase 下所有任务依次执行
2. 每个任务开始前 → Linear 设 In Progress
3. 每个任务完成后 → Linear 设 Done
4. 全部完成后输出 Phase 完成总结

## 二、完成任务

触发词：「XXX 做完了」「XXX 搞定了」「完成 XXX」「XXX 已完成」「XXX OK 了」
自动触发：AI 完成代码编写并验证通过时，无需用户口头确认

执行动作（全部为强制步骤）：
1. **【强制】** 在 plan 文件中将对应 todo 状态更新为 `completed`
2. **【强制】** 使用 Linear MCP `update_issue` 将对应 Issue 状态设为 `Done`
3. 输出确认信息 + 建议下一步要做的任务

注意：步骤 1 和 2 缺一不可，不能只更新本地而忽略 Linear

## 三、查看进度

触发词：「现在进度怎么样」「做到哪了」「还剩什么」「看看任务」「项目状态」

执行动作：
1. 读取 plan 文件，统计各状态的 todo 数量
2. 输出进度概览表格：
   - 已完成 / 进行中 / 待开始 的数量和百分比
   - 当前 Phase 进度
   - 当前进行中的任务列表
3. 如有 Linear 项目，同步展示 Linear 中的任务状态

## 四、跳过 / 暂停 / 取消任务

触发词：
- 跳过：「跳过 XXX」「先不做 XXX」「XXX 先放放」
- 暂停：「暂停 XXX」「XXX 先停一下」
- 取消：「取消 XXX」「不做 XXX 了」

执行动作：
1. 跳过/暂停：将 todo 状态保持或回退为 `pending`，在 Linear 中设为 `Backlog`
2. 取消：将 todo 状态设为 `cancelled`，在 Linear 中设为 `Canceled`

## 五、切换任务

触发词：「换到 XXX」「切到 XXX」「先去做 XXX」「转做 XXX」

执行动作：
1. 将当前 `in_progress` 的任务暂停（回退为 `pending`）
2. 将目标任务设为 `in_progress`
3. 同步更新 Linear 状态
4. 推荐新的 git 分支

## 六、添加任务

触发词：「加个任务 XXX」「还需要做 XXX」「补一个 XXX」「新增 XXX」

执行动作：
1. 在 plan 文件中添加新的 todo 项
2. 在 Linear 中创建对应 Issue
3. 输出新任务信息

## 七、提交代码

触发词：「提交一下」「commit」「保存进度」

执行动作：
1. 查看 git status 和 diff
2. 根据变更内容自动生成中文 commit message
3. 等待用户确认后执行 git add + commit

## 八、下一步

触发词：「下一步做什么」「接下来呢」「然后呢」

执行动作：
1. 查看 plan 文件，找到当前 Phase 中下一个 `pending` 的任务
2. 输出任务信息 + 推荐分支名
3. 询问用户是否开始

# ===== 输出格式规范 =====

所有工作流操作的输出使用以下格式：

```
-------- 工作流操作 --------
任务：{任务名称}
Plan ID：{todo id}
Phase：{所属 Phase}
状态：{旧状态} -> {新状态}
Linear：{Issue ID} {Issue 链接}
分支：{推荐分支名}（如适用）
----------------------------
```

# ===== 注意事项 =====

1. 始终使用中文与用户交流
2. 匹配任务时使用模糊匹配，用户不需要说出完整任务名
3. 如果匹配到多个任务，列出候选让用户选择
4. 每次操作后主动提示下一步建议
5. Linear 操作使用项目配置中的 team 和 name 字段（team 必须与 Linear 工作区中的实际团队名一致）
6. 如果 Linear MCP 不可用，跳过 Linear 操作，仅更新本地 plan 文件，并提示用户
7. 分支命名始终使用英文小写 + 短横线
8. 同步计划时，Phase 编号从标题中提取（如 `Phase 1`、`Phase 2`）
9. 同步前后都要给出清晰的报告，让用户确认
10. 双向同步时以用户明确指定的方向为准，不自动覆盖
11. **【最重要】任何任务状态变更都必须同时更新 plan 文件和 Linear，二者缺一不可**
12. **当用户说「做 Phase X 的全部代码」时，每完成一个子任务就立即更新 Linear，不要等到全部做完再批量更新**
